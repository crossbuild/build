#|src boost boost
#|src boost-accumulators boost/libs/accumulators
#|src boost-algorithm boost/libs/algorithm
#|src boost-align boost/libs/align
#|src boost-any boost/libs/any
#|src boost-array boost/libs/array
#|src boost-asio boost/libs/asio
#|src boost-assert boost/libs/assert
#|src boost-assign boost/libs/assign
#|src boost-atomic boost/libs/atomic
#|src boost-bimap boost/libs/bimap
#|src boost-bind boost/libs/bind
#|src boost-chrono boost/libs/chrono
#|src boost-circular_buffer boost/libs/circular_buffer
#|src boost-compatibility boost/libs/compatibility
#|src boost-compute boost/libs/compute
#|src boost-concept_check boost/libs/concept_check
#|src boost-config boost/libs/config
#|src boost-container boost/libs/container
#|src boost-context boost/libs/context
#|src boost-conversion boost/libs/conversion
#|src boost-convert boost/libs/convert
#|src boost-core boost/libs/core
#|src boost-coroutine boost/libs/coroutine
#|src boost-coroutine2 boost/libs/coroutine2
#|src boost-crc boost/libs/crc
#|src boost-date_time boost/libs/date_time
#|src boost-detail boost/libs/detail
#|src boost-disjoint_sets boost/libs/disjoint_sets
#|src boost-dll boost/libs/dll
#|src boost-dynamic_bitset boost/libs/dynamic_bitset
#|src boost-endian boost/libs/endian
#|src boost-exception boost/libs/exception
#|src boost-fiber boost/libs/fiber
#|src boost-filesystem boost/libs/filesystem
#|src boost-flyweight boost/libs/flyweight
#|src boost-foreach boost/libs/foreach
#|src boost-format boost/libs/format
#|src boost-function boost/libs/function
#|src boost-function_types boost/libs/function_types
#|src boost-functional boost/libs/functional
#|src boost-fusion boost/libs/fusion
#|src boost-geometry boost/libs/geometry
#|src boost-gil boost/libs/gil
#|src boost-graph boost/libs/graph
#|src boost-graph_parallel boost/libs/graph_parallel
#|src boost-hana boost/libs/hana
#|src boost-heap boost/libs/heap
#|src boost-icl boost/libs/icl
#|src boost-integer boost/libs/integer
#|src boost-interprocess boost/libs/interprocess
#|src boost-intrusive boost/libs/intrusive
#|src boost-io boost/libs/io
#|src boost-iostreams boost/libs/iostreams
#|src boost-iterator boost/libs/iterator
#|src boost-lambda boost/libs/lambda
#|src boost-lexical_cast boost/libs/lexical_cast
#|src boost-local_function boost/libs/local_function
#|src boost-locale boost/libs/locale
#|src boost-lockfree boost/libs/lockfree
#|src boost-log boost/libs/log
#|src boost-logic boost/libs/logic
#|src boost-math boost/libs/math
#|src boost-metaparse boost/libs/metaparse
#|src boost-move boost/libs/move
#|src boost-mpi boost/libs/mpi
#|src boost-mpl boost/libs/mpl
#|src boost-msm boost/libs/msm
#|src boost-multi_array boost/libs/multi_array
#|src boost-multi_index boost/libs/multi_index
#|src boost-multiprecision boost/libs/multiprecision
#|src boost-numeric_conversion boost/libs/numeric/conversion
#|src boost-interval boost/libs/numeric/interval
#|src boost-odeint boost/libs/numeric/odeint
#|src boost-ublas boost/libs/numeric/ublas
#|src boost-optional boost/libs/optional
#|src boost-parameter boost/libs/parameter
#|src boost-phoenix boost/libs/phoenix
#|src boost-polygon boost/libs/polygon
#|src boost-pool boost/libs/pool
#|src boost-predef boost/libs/predef
#|src boost-preprocessor boost/libs/preprocessor
#|src boost-program_options boost/libs/program_options
#|src boost-property_map boost/libs/property_map
#|src boost-property_tree boost/libs/property_tree
#|src boost-proto boost/libs/proto
#|src boost-ptr_container boost/libs/ptr_container
#|src boost-python boost/libs/python
#|src boost-qvm boost/libs/qvm
#|src boost-random boost/libs/random
#|src boost-range boost/libs/range
#|src boost-ratio boost/libs/ratio
#|src boost-rational boost/libs/rational
#|src boost-regex boost/libs/regex
#|src boost-scope_exit boost/libs/scope_exit
#|src boost-serialization boost/libs/serialization
#|src boost-signals boost/libs/signals
#|src boost-signals2 boost/libs/signals2
#|src boost-smart_ptr boost/libs/smart_ptr
#|src boost-spirit boost/libs/spirit
#|src boost-sort boost/libs/sort
#|src boost-statechart boost/libs/statechart
#|src boost-static_assert boost/libs/static_assert
#|src boost-system boost/libs/system
#|src boost-test boost/libs/test
#|src boost-thread boost/libs/thread
#|src boost-throw_exception boost/libs/throw_exception
#|src boost-timer boost/libs/timer
#|src boost-tokenizer boost/libs/tokenizer
#|src boost-tr1 boost/libs/tr1
#|src boost-tti boost/libs/tti
#|src boost-tuple boost/libs/tuple
#|src boost-type_erasure boost/libs/type_erasure
#|src boost-type_index boost/libs/type_index
#|src boost-type_traits boost/libs/type_traits
#|src boost-typeof boost/libs/typeof
#|src boost-units boost/libs/units
#|src boost-unordered boost/libs/unordered
#|src boost-utility boost/libs/utility
#|src boost-uuid boost/libs/uuid
#|src boost-variant boost/libs/variant
#|src boost-vmd boost/libs/vmd
#|src boost-wave boost/libs/wave
#|src boost-winapi boost/libs/winapi
#|src boost-xpressive boost/libs/xpressive
#|src boost-auto_index boost/tools/auto_index
#|src boost-bcp boost/tools/bcp
#|src boost-boostbook boost/tools/boostbook
#|src boost-boostdep boost/tools/boostdep
#|src boost-build boost/tools/build
#|src boost-inspect boost/tools/inspect
#|src boost-litre boost/tools/litre
#|src boost-quickbook boost/tools/quickbook
#|ins $target-gcc
#|ins $target-zlib-devel /$target/sys-root
#|ins $target-bzip2-devel /$target/sys-root
##|ins $target-python-devel /$target/sys-root
#|ins i686-build_pc-linux-gnu-boost-build
#|ins i686-build_pc-linux-gnu-coreutils
#|ins i686-build_pc-linux-gnu-diffutils
#|ins i686-build_pc-linux-gnu-file
#|ins i686-build_pc-linux-gnu-findutils
#|ins i686-build_pc-linux-gnu-gawk
#|ins i686-build_pc-linux-gnu-gcc
#|ins i686-build_pc-linux-gnu-grep
#|ins i686-build_pc-linux-gnu-sed
#|pkg name $target-boost-debug
#|pkg + /usr/lib/debug
#|pkg name nopackage
#|pkg . /usr
#|pkg . /usr/include
#|pkg . /usr/lib*
export PATH=$srcdir/bin
BLDDIR=$PWD/build
mkdir -p $BLDDIR
cd boost
echo "using gcc : cross : $target-g++ ;" > tools/build/src/user-config.jam
case "$target_opt_flags" in
    *-Os*)
	boostopt=space
	boostoptname=optimization-space/
	;;
    *)
	boostopt=speed
	boostoptname=
	;;
esac
b2 headers
b2 \
    --build-dir=$BLDDIR \
    toolset=gcc-cross \
    optimization=$boostopt \
    debug-symbols=on \
    $parallel \
    --without-mpi \
    --without-context \
    --without-coroutine \
    --without-coroutine2 \
    --without-python \
    --prefix=$destdir/usr \
    --exec-prefix=$destdir/usr \
    --libdir=$destdir/usr/$lib \
    --includedir=$destdir/usr/include install
cd ..

BOOSTVER=$(sed -ne 's,constant BOOST_VERSION : \(.*\) ;,\1,p' boost/Jamroot)

find boost/libs/*/include/boost boost/libs/*/*/include/boost -type f \
	-not -name '*.bat' \
	-not -name '*.cpp' \
	-not -name '*.dtd' \
	-not -name '*.m4' \
	-not -name '*.patch' \
	-not -name '*.pl' \
	-not -name '*.sh' \
	-not -name '*.txt' \
	> filelist
diff -u <(
	find $destdir/usr/include/boost/ -type f | sort -u
    ) <(
	sed -e "s,^boost/libs/.*/include/boost/,$destdir/usr/include/boost/," filelist |
	sort -u
    )
sed -e 's,^boost/libs/\(.*\)/include/\(boost/.*\),\1 \2,' filelist |
sort -u |
sort -k 2 > fileprovides
join -j 2 -o 2.1 1.1 fileprovides <(
    xargs -a filelist grep '^[[:space:]]*#[[:space:]]*include[[:space:]]*<boost' |
    sed -e 's,^boost/libs/\(.*\)/include/[^<]*<\(boost/[^>]*\)>.*,\1 \2,' |
    sort -u |
    sort -k 2
) |
awk '{if ($1 != $2) {print}}' |
sort -u |
sed -e 's,/,-,g;s,^\([^ ]*\) \(.*\)$,\1 b #|pkg dep '"$target"'-boost-\2-devel,' > pkgdeps
sed -e 's,/,-,g;s,\(.*\) .*,\1 a #|pkg name '"$target"'-boost-\1-devel\n\1 b #|pkg auto '"$target"'\n\1 b #|pkg dep '"$target"'-glibc-devel,' fileprovides |
sort -u > pkgname
sed -e 's,^boost/libs/\(.*\)/include/boost/,\1 c #|pkg . /usr/include/boost/,' filelist |
sed -e 's,/\(.*\) ,-\1 ,' > pkglist
sed -e 's,/,-,g;s,\(.*\) .*,0 b #|pkg dep '"$target"'-boost-\1-devel,' fileprovides |
sort -u > globaldeps
ls build/boost/bin.v2/libs/*/build/gcc-cross/release/debug-symbols-on/link-static/${boostoptname}threading-multi/libboost_*.a |
sed -e 's,^build/boost/bin.v2/libs/\([^/]*\)/build/gcc-cross/release/.*/libboost_\(.*\)\.a$,\1 \2,' |
sort -u > statics
ls build/boost/bin.v2/libs/*/build/gcc-cross/release/debug-symbols-on/${boostoptname}threading-multi/libboost_*.so.* |
sed -e 's,^build/boost/bin.v2/libs/\([^/]*\)/build/gcc-cross/release/.*/libboost_\(.*\)\.so\..*$,\1 \2,' |
sort -u > dynamics
sed -e 's,\(.*\) \(.*\),\1 c #|pkg . /usr/'"$lib"'/libboost_\2.so\n2-\2 a #|pkg name '"$target"'-libboost_\2-'"${BOOSTVER//./-}"'\n2-\2 b #|pkg auto '"$target"'\n2-\2 c #|pkg . /usr/'"$lib"'/libboost_\2.so.'"$BOOSTVER"',' dynamics > pkgdynamics
diff statics dynamics |
sed -ne 's,^< \(.*\) \(.*\),\1 c #|pkg . /usr/'"$lib"'/libboost_\2.a,p' > pkgstatics
sort dynamics statics |
uniq -d |
sed -ne 's,.* \(.*\),1 c #|pkg . /usr/'"$lib"'/libboost_\1.a,p' > globalstatics
for i in accumulators algorithm align asio assign atomic bimap bind \
	chrono/stopwatches circular_buffer compatibility compute \
	concept_check config container context convert core coroutine \
	coroutine2 date_time dll dynamic_bitset endian fiber filesystem \
	flyweight format function function_types functional fusion geometry \
	gil hana heap icl integer interprocess intrusive io iostreams \
	iterator lambda lexical_cast local_function locale lockfree log \
	logic math metaparse move mpi mpl msm multi_array multi_index \
	multiprecision numeric/conversion numeric/interval numeric/odeint \
	numeric/ublas optional parameter phoenix polygon pool predef \
	preprocessor program_options property_map property_tree proto \
	ptr_container python qvm random range ratio regex serialization \
	signals signals2 smart_ptr sort spirit statechart system test thread \
	timer tr1 tti tuple type_erasure type_index type_traits typeof units \
	unordered uuid variant vmd wave xpressive; do
    ( cd $destdir && find usr/include/boost/$i -type d ) |
    sed -e "s,^,${i/\//-} c #|pkg . /," >> pkglist
done
( cd $destdir && find usr/include/boost/archive -type d ) |
sed -e "s,^,serialization c #|pkg . /," >> pkglist
( cd $destdir && find usr/include/boost/chrono/{detail,io,io_v1,typeof} -type d ) |
sed -e "s,^,chrono c #|pkg . /," >> pkglist
( cd $destdir && find usr/include/boost/concept -type d ) |
sed -e "s,^,concept_check c #|pkg . /," >> pkglist
( cd $destdir && find usr/include/boost/graph/{distributed,parallel} -type d ) |
sed -e "s,^,graph_parallel c #|pkg . /," >> pkglist
cat <<EOT > globalheader
0 a #|pkg name $target-boost-devel
0 b #|pkg auto $target
1 a #|pkg name $target-boost-devel-static
1 b #|pkg auto $target
1 b #|pkg dep $target-boost-devel
config b #|pkg . /usr/include/boost
config b #|pkg . /usr/include/boost/detail
chrono b #|pkg . /usr/include/boost/chrono
core b #|pkg . /usr/include/boost/utility
exception b #|pkg . /usr/include/boost/exception/detail
graph b #|pkg . /usr/include/boost/graph
graph b #|pkg . /usr/include/boost/graph/detail
graph b #|pkg . /usr/include/boost/graph/planar_detail
graph b #|pkg . /usr/include/boost/graph/property_maps
iterator b #|pkg . /usr/include/boost/pending
iterator b #|pkg . /usr/include/boost/pending/detail
numeric-conversion b #|pkg . /usr/include/boost/numeric
throw_exception b #|pkg . /usr/include/boost/exception
utility b #|pkg . /usr/include/boost/utility/detail
winapi b #|pkg . /usr/include/boost/detail/winapi
winapi b #|pkg . /usr/include/boost/detail/winapi/detail
EOT
mkdir -p .pkg
sort globalheader globaldeps globalstatics pkgname pkgdeps pkglist pkgdynamics pkgstatics |
sed -e 's,^[^ ]* . ,,' > .pkg/dynamic

$recipes/strip_debug --strip-all $target $destdir /usr/lib/debug /
